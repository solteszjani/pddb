{% extends "base.html" %}
{% block title %}Szolgálat vezénylés{% endblock %}

{% block content %}
<h1>Szolgálat vezénylés - {{ year }}/{{ month }}</h1>

<div class="month-nav">
    <a href="{{ url_for('shifts', year=prev_year, month=prev_month) }}">&laquo; Előző hónap</a> |
    <a href="{{ url_for('shifts', year=next_year, month=next_month) }}">Következő hónap &raquo;</a>
</div>

<table class="table table-bordered table-sm">
    <thead>
        <tr>
            <th>Felhasználó</th>
            {% for d in range(1, num_days+1) %}
                <th>{{ d }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>{{ user.full_name or user.username }}</td>
            {% for d in range(1, num_days+1) %}
                {% set dt = date(year, month, d) %}
                {% set shift = shifts_data[user.id].get(dt) %}
                <td class="shift-cell-container">
                    <div class="shift-card-container">
                        <!-- Shift kártya -->
                        <div class="shift-card {{ shift.status if shift else '' }}"
                             data-user-id="{{ user.id }}"
                             data-shift-date="{{ dt }}">
                            {% if shift %}
                                {{ shift.start_time or '-' }} - {{ shift.end_time or '-' }}
                            {% else %}
                                -
                            {% endif %}
                        </div>

                        <!-- Hover kártya modern stílus -->
                        {% if shift %}
                        <div class="shift-hover-card">
                            <div class="shift-hover-card-status {{ shift.status }}">{{ shift.status }}</div>
                            <div><strong>Eligazítás:</strong> {{ shift.service_type or '-' }}</div>
                            <div><strong>Idő:</strong> {{ shift.start_time or '-' }} - {{ shift.end_time or '-' }}</div>
                            <div><strong>Gépjármű:</strong> {{ shift.car or '-' }}</div>
                            <div><strong>Parancsnok:</strong> {{ shift.leader or '-' }}</div>
                            <div><strong>Járőrtárs:</strong> {{ shift.partner or '-' }}</div>
                        </div>
                        {% endif %}

                        <!-- Szerkesztő form -->
                        {% if can_edit %}
                        <div class="shift-edit-form d-none">
                            <label>Szolgálati idő:</label>
                            <input type="time" name="start" value="{{ shift.start_time if shift else '' }}">
                            -
                            <input type="time" name="end" value="{{ shift.end_time if shift else '' }}"><br>
                            <label>Eligazítás szövege:</label>
                            <input type="text" name="service_type" value="{{ shift.service_type if shift else '' }}"><br>
                            <label>Szolgálati gépkocsi:</label>
                            <input type="text" name="car" value="{{ shift.car if shift else '' }}"><br>
                            <label>Parancsnok:</label>
                            <input type="text" name="leader" value="{{ shift.leader if shift else '' }}"><br>
                            <label>Járőrtárs:</label>
                            <input type="text" name="partner" value="{{ shift.partner if shift else '' }}"><br>
                            <label>Állapot:</label>
                            <select name="status">
                                <option value="Tervezet" {% if shift and shift.status=='Tervezet' %}selected{% endif %}>Tervezet</option>
                                <option value="Hiteles" {% if shift and shift.status=='Hiteles' %}selected{% endif %}>Hiteles</option>
                            </select>
                            <div class="mt-1">
                                <button type="button" class="btn btn-sm btn-success save-btn">Mentés</button>
                                <button type="button" class="btn btn-sm btn-danger delete-btn">Törlés</button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<style>
.shift-cell-container { position: relative; }

/* Shift kártya */
.shift-card {
    display: block;
    padding: 5px 8px;
    margin: 2px 0;
    border-radius: 6px;
    font-size: 0.85em;
    cursor: pointer;
    text-align: center;
    transition: background 0.2s, transform 0.2s;
}
.shift-card.Tervezet { background-color: #fff3cd; }
.shift-card.Hiteles { background-color: #d4edda; }

/* Hover kártya modern stílus */
.shift-hover-card {
    display: none;
    position: absolute;
    top: 110%;
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    padding: 15px 20px;
    font-size: 0.85em;
    text-align: left;
    z-index: 50;
    min-width: 240px;
    white-space: normal;
    opacity: 0;
    transition: all 0.3s ease;
}

.shift-hover-card::before {
    content: '';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 0 10px 10px 10px;
    border-style: solid;
    border-color: transparent transparent #ffffff transparent;
}

.shift-hover-card div { margin-bottom: 6px; }
.shift-hover-card div strong { color: #495057; }

/* Státusz címke */
.shift-hover-card-status {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 0.75em;
    font-weight: bold;
    color: #fff;
    margin-bottom: 8px;
}
.shift-hover-card-status.Tervezet { background-color: #ffc107; }
.shift-hover-card-status.Hiteles { background-color: #28a745; }

/* Szerkesztő form */
.shift-edit-form {
    background: #f8f9fa;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 6px;
    position: absolute;
    top: 30px;
    left: 0;
    z-index: 100;
    min-width: 220px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.shift-card');

    cards.forEach(card => {
        const container = card.parentElement;
        const hoverCard = container.querySelector('.shift-hover-card');
        const form = container.querySelector('.shift-edit-form');

        // Csak shift-kártya hover esetén jelenik meg
        card.addEventListener('mouseenter', () => {
            if(hoverCard) {
                hoverCard.style.display = 'block';
                setTimeout(() => hoverCard.style.opacity = 1, 10);
            }
        });
        card.addEventListener('mouseleave', () => {
            if(hoverCard) {
                hoverCard.style.opacity = 0;
                setTimeout(() => hoverCard.style.display = 'none', 300);
            }
        });

        // Dupla kattintás: szerkesztés, nem tűnik el
        card.addEventListener('dblclick', () => {
            if(form) form.classList.toggle('d-none');
        });

        if(!form) return;

        // Mentés
        form.querySelector('.save-btn').addEventListener('click', async () => {
            const payload = {
                user_id: card.dataset.userId,
                shift_date: card.dataset.shiftDate,
                start_time: form.querySelector('input[name="start"]').value,
                end_time: form.querySelector('input[name="end"]').value,
                service_type: form.querySelector('input[name="service_type"]').value,
                car: form.querySelector('input[name="car"]').value,
                leader: form.querySelector('input[name="leader"]').value,
                partner: form.querySelector('input[name="partner"]').value,
                status: form.querySelector('select[name="status"]').value
            };

            try {
                const resp = await fetch('{{ url_for("save_shift_ajax") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if(data.success){
                    card.textContent = (payload.start_time || '-') + ' - ' + (payload.end_time || '-');
                    card.className = 'shift-card ' + payload.status;
                } else {
                    alert('Mentés sikertelen!');
                }
            } catch(e){
                alert('Hálózati hiba!');
            }
        });

        // Törlés
        form.querySelector('.delete-btn').addEventListener('click', async () => {
            const payload = {
                user_id: card.dataset.userId,
                shift_date: card.dataset.shiftDate
            };
            try {
                const resp = await fetch('{{ url_for("delete_shift_ajax") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if(data.success){
                    card.textContent = '-';
                    card.className = 'shift-card';
                    form.classList.add('d-none');
                } else {
                    alert('Törlés sikertelen!');
                }
            } catch(e){
                alert('Hálózati hiba!');
            }
        });
    });
});
</script>
{% endblock %}
