{% extends 'base.html' %}
{% block content %}

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<h3>{% if report %}Jelentés szerkesztése{% else %}Új jelentés{% endif %}</h3>
<form method="post" enctype="multipart/form-data">

  <div class="mb-3">
    <label class="form-label">Intézkedés (Kötelező kiválasztani)</label>
    <select name="action_id" class="form-select">
      <option value="">-- válassz intézkedést --</option>
      {% for a in actions %}
        <option value="{{ a.id }}" {% if report and report.action_id==a.id %}selected{% endif %}>
            #{{ a.id }} - {{ a.location }} ({{ a.action_date }})
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-2">
    <label>Jelentéstípus</label>
    <select class="form-select" name="report_type_id">
        {% set types = [
            "Rendőri jelentés",
            "Feljegyzés",
            "Szabálysértési feljelentés",
            "Jelentés elfogás/előállításról",
            "Jelentés letartóztatásról",
            "Határozat",
            "Szolgálati jegy",
            "Parancsnoki kivizsgálás",
            "Jelentés tanú/gyanúsított kihallgatásáról",
            "Határozat tárgy lefoglalásról"
        ] %}
        {% for t in types %}
        <option value="{{ t }}" 
            {% if report and report.report_type and report.report_type.name == t %}selected{% endif %}>
            {{ t }}
        </option>
        {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">Cím</label>
    <input name="title" class="form-control" value="{{ report.title if report else '' }}">
  </div>

  <!-- Editor -->
  <div class="mb-3">
    <label class="form-label">Történtek hosszú leírása</label>
    <div id="toolbar">
      <span class="ql-formats">
        <select class="ql-size"></select>
      </span>
      <span class="ql-formats">
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>
        <button class="ql-strike"></button>
      </span>
      <span class="ql-formats">
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
      </span>
      <span class="ql-formats">
        <select class="ql-align">
          <option selected></option>
          <option value="center"></option>
          <option value="right"></option>
          <option value="justify"></option>
        </select>
      </span>
      <span class="ql-formats">
        <button class="ql-link"></button>
        <button class="ql-image"></button>
      </span>
    </div>

    <div id="editor" style="min-height:200px; background:white;">
      {{ report.content|safe if report else "" }}
    </div>

    <textarea name="content" id="content-input" style="display:none;"></textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">Kiosztás</label>
    <select name="assignee_id" class="form-select">
      <option value="">-- nincs --</option>
      {% for u in users %}
        <option value="{{ u.id }}" {% if report and report.assignee_id==u.id %}selected{% endif %}>
            {{ u.username }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">Fájlok</label>
    <input name="files" type="file" class="form-control" multiple>
  </div>

  <button class="btn btn-primary">Mentés</button>
</form>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
  // 1️⃣ Betűméret formátum (számok 10-50)
  var Size = Quill.import('formats/size');
  Size.whitelist = [];
  for(let i=10;i<=50;i+=2){ Size.whitelist.push(i.toString()); }
  Quill.register(Size, true);

  // 2️⃣ CSS osztályok a méretekhez
  var style = document.createElement('style');
  Size.whitelist.forEach(s => {
    style.innerHTML += `.ql-snow .ql-size-${s} { font-size: ${s}px; }\n`;
  });
  document.head.appendChild(style);

  // 3️⃣ Dropdown feltöltése
  var sizeSelect = document.querySelector('.ql-size');
  Size.whitelist.forEach(s=>{
    let option = document.createElement('option');
    option.value = s;
    option.text = s + 'px';
    sizeSelect.appendChild(option);
  });
  sizeSelect.value = '14'; // alapértelmezett

  // 4️⃣ Editor inicializálása
  var quill = new Quill('#editor',{
    theme:'snow',
    modules:{ toolbar:'#toolbar' }
  });

  // 5️⃣ Form submit
  document.querySelector('form').onsubmit = function(){
    document.getElementById('content-input').value = quill.root.innerHTML;
  };
</script>

{% endblock %}
